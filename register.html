
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="plugins/bootstrap-4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/all.min.css">    
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <style type="text/css">
        .con4 {
            width: 300px;
            height: auto;
            overflow: hidden;
            margin: 20px auto;
            color: #FFFFFF;
        }
        .con4 .btn{
            width: 100%;
            height: 40px;
            text-align: center;
            background: #f55d54;
            border-color: #f55d54;
            display: block;
            font-size: 16px;
            border-radius: 5px;
        }
        /*.upload_pic {*/
        /*    display: block;*/
        /*    width: 100%;*/
        /*    height: 40px;*/
        /*    position: absolute;*/
        /*    left: 0;*/
        /*    top: 0;*/
        /*    opacity: 0;*/
        /*    border-radius: 5px;*/
        /*}*/

        #cvs {
            border: 1px solid #000;
            margin: 20px 0 20px 50px;
        }
    </style>
    <title>注册</title>
    <style>
        .container{
            display:table;
            height:100%;
        }

        .row{
            display: table-cell;
            vertical-align: middle;
        }
        .row-centered {
            text-align:center;
        }
        .col-centered {
            display:inline-block;
            float:none;
            text-align:left;
            margin-right:-4px;
        }
        .bgcolor_red{
            background-color:#f55d54;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-light">
    <a class="navbar-brand" href="#">
        <img src="images/PNG.png" width="30" height="30" class="d-inline-block align-top" alt="">
        <span class="home-name">云活动系统</span>
    </a>
    <div class="nav-list">
        <a href="#" class="nav-list-item">首页</a>
    </div>
</nav>
<div class="container main-content  ">
    <div class="col-12 " >
        <div class="card  text-center" >
            <div class="card-header">
                用户注册
            </div>
            <div class="card-body ">
                <form class="col-centered" id="form">
                    <div class="con4">
                        <canvas id="cvs" width="200" height="200"></canvas>
                        <div>
                            <label for="UploadAvatar" class="btn btn-primary" style="display: block; width: 100px;margin:auto">上传文件</label>
                            <input type="file" class="upload_pic btn" id="UploadAvatar" name="file" style="display: none"/>
                        </div>
                    </div>
                    <table style="border-collapse: separate;border-spacing: 10px 10px;">
                        <tr>
                            <td class="margin-top:10">
                                <label for="username">用户名：</label>
                            </td>
                            <td>
                                <input type="text" required name="username" id="username">
                            </td>
                        </tr>
                        <tr>
                        <td>
                            <label for="password">密码:</label>
                        </td>
                        <td>
                            <input type="password" required name="password" id="password" >
                        </td>
                    </tr>
                        <tr>
                            <td>
                                <label for="confirm_password">确认密码:</label>
                            </td>
                            <td>
                                <input type="password" required name="confirm_password" id="confirm_password">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="phoneNumber">联系电话:</label>
                            </td>
                            <td>
                                <input type="text" name="phoneNumber" id="phoneNumber" >
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="email">邮箱：</label>
                            </td>
                            <td>
                                <input required id="email" name="email" type="text">
                                <input type="button" value="发送验证码" id="send_mail">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="check_code">验证码:</label>
                            </td>
                            <td>
                                <input required name="check_code" id="check_code" >
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="gender">性别:</label>
                            </td>
                            <td>
                                <select class="selectpicker show-tick form-control selectsize" data-live-search="true" id="gender" >
                                    <option>男</option>
                                    <option>女</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="type">用户类型:</label>
                            </td>
                            <td>
                                <select class="selectpicker show-tick form-control selectsize" data-live-search="true" id="type" >
                                    <option>个人</option>
                                    <option>企业</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <h5>扩展信息：</h5>
                    <table style="border-collapse: separate;border-spacing: 10px 10px;">
                        <tr>
                            <td class="margin-top:10">
                                <label for="company">个人单位：</label>
                            </td>
                            <td>
                                <input type="text"  name="company" id="company">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="profession">个人职业:</label>
                            </td>
                            <td>
                                <input type="text"  name="profession" id="profession">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="address">个人住址:</label>
                            </td>
                            <td>
                                <input type="text"  name="address" id="address">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="introduction">简介:</label>
                            </td>
                            <td>
                                <input  type="text" name="introduction" id="introduction">
                            </td>
                        </tr>
                    </table>
                    <div class="bg-white" style="text-align: center;">
                        <button type="button" class="btn bgcolor_red" id="register" disabled>注册</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
<footer class="footer" id="footer">
    <div class="container">
        <div class="row mt-3" style="text-align: center;">
            <small class="w-100">Copyright © 2019 PNG</small>
        </div>
    </div>
</footer>

<script src="plugins/jquery/jquery-3.4.1.min.js"></script>
<script src="plugins/popper/popper.min.js"></script>
<script src="plugins/bootstrap-4.3.1/js/bootstrap.min.js"></script>
<script src="js/nav.min.js"></script>
<script>
    // 消息框
    function readAvatar() {
        console.log(this.files); // 调试
        var file = this.files[0]; //获取上传文件列表中第一个文件
        if (!/image\/\w+/.test(file.type)) {
            //图片文件的type值为image/png或image/jpg
            alert("文件必须为图片！");
            return false;
        }
        // console.log(file);
        var reader = new FileReader(); //实例一个文件对象
        reader.readAsDataURL(file); //把上传的文件转换成url
        //当文件读取成功便可以调取上传的接口
        reader.onload = function(e) {
            var image = new Image();
            image.src = e.target.result;
            image.onload = function() {
                var canvas = document.getElementById("cvs");
                var ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(image, 0, 0, 200, 200);
            };
        }
    }
    // html加载时执行
    $(function () {
        // 验证登录
        checkLogin(true, true);
        // 头像上传预览
        $('#UploadAvatar').on('change', readAvatar);
        // 邮箱验证码验证
        $('#check_code').on('change', function (e) {
            $.post('api/mail/checkMail/', {"code": $('#check_code').val()}, function (data) {
                if (data.status_check) {
                    $('#register').removeAttr('disabled');
                } else {
                    toastMessage('验证码错误');
                }
            })
        });
        // 邮箱发送验证码
        $('#send_mail').click(function (e) {
            $.post('api/mail/sendMail/', {'email': $('#email').val()}, function (data) {
                if (data.status_email) {
                    toastMessage('邮箱已注册');
                } else if (data.isSended) {
                    var btn_send_mail = $('#send_mail');
                    btn_send_mail.prop('disabled', true);
                    var time = 120;
                    var timer = setInterval(function () {
                        btn_send_mail.val(time+'秒后重新发送');
                        time--;
                        if (time <= 0) {
                            btn_send_mail.val('重新发送');
                            btn_send_mail.removeAttr('disabled');
                            clearInterval(timer);
                        }
                    }, 1000);
                } else {
                    toastMessage('好像有些错误..邮件没有发出去..')
                }
            });
        });
        /**
         * request{ avatar, username, password, phone_number, company, profession, address, introduction}
         * response {status: True, message: message}
         */
        $('#register').click(function (e) {
          let password = $('#password').val();
          let confirmPassword = $('#confirm_password').val();
          if (password !== confirmPassword) {
              toastMessage('两次密码');
              return;
          }
          let avatar = $('#UploadAvatar')[0].files[0];
          // 限制上传文件大小
          if (avatar){
              console.log(avatar.size);
          }else{
              avatar="D:\FRONTEND\MeetingSystemFrontEnd\default.jpg";   
          }
          if (avatar.size >= 102400) {
              toastMessage('上传的头像不能超过100k!');
              return;
          }
          
          let form = new FormData();
          form.append('avatar', avatar); // 头像
          form.append('username', $('#username').val());
          form.append('password', password);
          form.append('phone_number', $('#phoneNumber').val());
          form.append('company', $('#company').val());
          form.append('profession', $('#profession').val());
          form.append('address', $('#address').val());
          form.append('email', $('#email').val());
          form.append('gender', $('#gender').val());
          form.append('type', $('#type').val());
          form.append('introduction', $('#introduction').val());
          $.ajax({
              type: 'post',
              url: 'api/register/',
              data: form,
              async: false,
              contentType: false,
              processData: false,
              success: function (data) {
                  if (data.status) {
                      $('#message').text('注册成功，正在跳转...');
                      window.location.href='login.html';
                  } else {
                      $('#message').text(data.message);
                      $('.toast').toast('show');
                  }
              }
          });
       });
    });
</script>
<script>
    function validateForm(){
        var x=document.forms["myForm"]["fname"].value;
        if (x==null || x===""){
            alert("姓必须填写");
            return false;
        }
    }
</script>
</body>
</html>
