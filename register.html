<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="plugins/bootstrap-4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <style type="text/css">
        .con4 {
            width: 300px;
            height: auto;
            overflow: hidden;
            margin: 20px auto;
            color: #FFFFFF;
        }
        .con4 .btn {
            width: 100%;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background: #d8b49c;
            display: block;
            font-size: 16px;
            border-radius: 5px;
        }

        .upload {
            float: left;
            position: relative;
        }
        .upload_pic {
            display: block;
            width: 100%;
            height: 40px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            border-radius: 5px;
        }

        #cvs {
            border: 1px solid #000;
            margin: 20px 0 20px 50px;
        }
    </style>
    <title>注册</title>
    <style>
        .container{
            display:table;
            height:100%;
        }

        .row{
            display: table-cell;
            vertical-align: middle;
        }
        .row-centered {
            text-align:center;
        }
        .col-centered {
            display:inline-block;
            float:none;
            text-align:left;
            margin-right:-4px;
        }
        .bgcolor_red{
            background-color:#f55d54;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-light">
    <a class="navbar-brand" href="#">
        <img src="https://y4ngyy.xyz/assets/avatar.jpg" width="30" height="30" class="d-inline-block align-top" alt="">
        <span class="home-name">云会议系统</span>
    </a>
    <div class="nav-list">
        <a href="#" class="nav-list-item">首页</a>
    </div>
</nav>
<div class="toast w-25" role="alert" aria-live="assertive" aria-atomic="true" data-delay="2000" id="message-box">
    <div class="toast-header bg-danger text-white">
        <strong>提示</strong>
    </div>
    <div class="toast-body p-3" id="message">
    </div>
</div>
<div class="container main-content  ">
    <div class="col-12 " >
        <div class="card  text-center" >
            <div class="card-header">
                用户注册
            </div>
            <div class="card-body ">
                <form class="col-centered" id="form">
                    <div class="con4">
                        <canvas id="cvs" width="200" height="200"></canvas>
                        <span class="btn upload">上传头像<input type="file" class="upload_pic" id="UploadAvatar" name="file"/></span>
                    </div>
                    <table style="border-collapse: separate;border-spacing: 10px 10px;">
                        <tr>
                            <td class="margin-top:10">
                                <label for="username">用户名：</label>
                            </td>
                            <td>
                                <input type="text" required name="username" id="username">
                            </td>
                        </tr>
                        <tr>
                        <td>
                            <label for="password">密码:</label>
                        </td>
                        <td>
                            <input type="password" required name="password" id="password" >
                        </td>
                    </tr>
                        <tr>
                            <td>
                                <label for="confirm_password">确认密码:</label>
                            </td>
                            <td>
                                <input type="password" required name="confirm_password" id="confirm_password">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="phoneNumber">联系电话:</label>
                            </td>
                            <td>
                                <input type="text" name="phoneNumber" id="phoneNumber" >
                            </td>
                        </tr>
                    </table>
                    <h5>扩展信息：</h5>
                    <table style="border-collapse: separate;border-spacing: 10px 10px;">
                        <tr>
                            <td class="margin-top:10">
                                <label for="company">个人单位：</label>
                            </td>
                            <td>
                                <input type="text"  name="company" id="company">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="profession">职业:</label>
                            </td>
                            <td>
                                <input type="text"  name="profession" id="profession">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="address">个人住址:</label>
                            </td>
                            <td>
                                <input type="text"  name="address" id="address">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="introduction">简介:</label>
                            </td>
                            <td>
                                <input  type="text" name="introduction" id="introduction">
                            </td>
                        </tr>
                    </table>
                    <div class="bg-white" style="text-align: center;">
                        <button type="button" class="btn bgcolor_red" id="register">注册</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
<footer class="footer" id="footer">
    这是页脚
</footer>

<script src="plugins/fontawesome/font-awesome.js"></script>
<script src="plugins/jquery/jquery-3.4.1.min.js"></script>
<script src="plugins/popper/popper.min.js"></script>
<script src="plugins/bootstrap-4.3.1/js/bootstrap.min.js"></script>
<script src="js/nav.js"></script>
<script>
    $(function () {
        checkLogin(true, true);
    });
</script>
<script>
    $(function () {
        function readAvatar() {

            console.log(this.files); // 调试
            var file = this.files[0]; //获取上传文件列表中第一个文件
            if (!/image\/\w+/.test(file.type)) {
                //图片文件的type值为image/png或image/jpg
                alert("文件必须为图片！");
                return false;
            }
            // console.log(file);
            var reader = new FileReader(); //实例一个文件对象
            reader.readAsDataURL(file); //把上传的文件转换成url
            //当文件读取成功便可以调取上传的接口
            reader.onload = function(e) {
                // console.log(this.result);//文件路径
                // console.log(e.target.result);//文件路径
                /*var data = e.target.result.split(',');
        var tp = (file.type == 'image/png')? 'png': 'jpg';
        var imgUrl = data[1];//图片的url，去掉(data:image/png;base64,)
        //需要上传到服务器的在这里可以进行ajax请求
        // console.log(imgUrl);
        // 创建一个 Image 对象
        var image = new Image();
        // 创建一个 Image 对象
        // image.src = imgUrl;
        image.src = e.target.result;
        image.onload = function(){
            document.body.appendChild(image);
        }*/
                var image = new Image();
                // 设置src属性
                image.src = e.target.result;
                var max = 200;
                // 绑定load事件处理器，加载完成后执行，避免同步问题
                image.onload = function() {
                    // 获取 canvas DOM 对象
                    var canvas = document.getElementById("cvs");
                    // 如果高度超标 宽度等比例缩放 *=
                    /*if(image.height > max) {
                image.width *= max / image.height;
                image.height = max;
            } */
                    // 获取 canvas的 2d 环境对象,
                    var ctx = canvas.getContext("2d");
                    // canvas清屏
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // 重置canvas宽高
                    /*canvas.width = image.width;
            canvas.height = image.height;
            if (canvas.width>max) {canvas.width = max;}*/
                    // 将图像绘制到canvas上
                    // ctx.drawImage(image, 0, 0, image.width, image.height);
                    ctx.drawImage(image, 0, 0, 200, 200);
                    // 注意，此时image没有加入到dom之中
                };
            }
        }
       $('#UploadAvatar').on('change', readAvatar);

        /**
         * request{ file, username, password, phoneNumber, company, profession, address, introduction}
         * response {status: True, message: message}
         */
        $('#register').click(function (e) {
          var password = $('#password').val();
          var confirmPassword = $('#confirm_password').val();
          if (password !== confirmPassword) {
              $('#message').text('两次密码输入不一致');
              $('.toast').toast('show');
              return;
          }
          var form = new FormData();
          form.append('file',$('#UploadAvatar')[0].files[0]);
          form.append('username', $('#username').val());
          form.append('password', password);
          form.append('phoneNumber', $('#phoneNumber').val());
          form.append('company', $('#company').val());
          form.append('profession', $('#profession').val());
          form.append('address', $('#address').val());
          form.append('introduction', $('#introduction').val());
          $.ajax({
              type: 'post',
              url: 'upload.php',
              data: form,
              async: false,
              contentType: false,
              processData: false,
              success: function (data) {
                  if (data.status) {
                      $('#message').text('注册成功，正在跳转...');
                      window.location.href='login.html';
                  } else {
                      $('#message').text(data.message);
                      $('.toast').toast('show');
                  }
              }
          });
       });
    });
</script>
</body>
</html>
