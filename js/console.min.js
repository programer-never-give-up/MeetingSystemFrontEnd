function deleteActivity(uuid){$.ajax({url:'api/activity/deleteActivity/',type:'POST',data:{uuid:uuid},success:function(data){toastMessage(data['message']);if(data.act_status){$('#delete-button-'+uuid).parent().parent().remove();}},error:function(){toastMessage('请求提交失败');}});}
function canselAplay(uuid_act){console.log(uuid_act);$.ajax({url:'api/yw/cancelApply/',type:'POST',data:{uuid_act:uuid_act},success:function(data){toastMessage(data['message']);$('#delete-button-'+uuid_act).parent().parent().remove();},error:function(){toastMessage('请求提交失败');}});}
function cancelCollection(uuid_act){$.ajax({url:'api/yw/cancelCollection/',type:'POST',data:{uuid_act:uuid_act},success:function(data){toastMessage(data['message']);$('#delete-button-'+uuid_act).parent().parent().remove();},error:function(){toastMessage('请求提交失败');}});}
function cancelApplication(act_uuid){$.ajax({url:'api/activity/cancelApplication/',type:'POST',data:{act_uuid:act_uuid},success:function(data){toastMessage(data['message']);$('#delete-button-'+act_uuid).parent().parent().remove();},error:function(){toastMessage('请求提交失败');}});}
function applayToIndex(act_uuid){$.ajax({url:'api/activity/applyRecommend/',data:{act_uuid:act_uuid},type:'POST',dataType:'json',success:function(data){toastMessage(data['message']);},error:function(){toastMessage('请求提交失败');}})}
function generateActivityTable(data,buttomType){$activityTable=$('<table class="w-100" style="margin-top: 3%"></table>');$actTableHead=$('<thead></thead>');$actTableHead.append('<tr></tr>');if(buttomType=='management-published'){$actTableHead.children('tr').append('<th>首页</th>');}
$actTableHead.children('tr').append('<th>活动logo</th>');$actTableHead.children('tr').append('<th>活动名称</th>');$actTableHead.children('tr').append('<th>活动地点</th>');$actTableHead.children('tr').append('<th>活动时间</th>');if(buttomType=="management-to_be_audited"){$actTableHead.children('tr').append('<th>操作类型</th>');}
$activityTable.append($actTableHead);$actTableBody=$('<tbody class="activity-card">\n'+'\n'+'                    </tbody>');for(index in data["activities"]){activity=data["activities"][index];var $itemCard=$('<tr class="item-card"></tr>');if(buttomType=='management-published'){var $starTd=$('<td><a><img style="width: 20px;height: 20px"></a>')
if(activity['ifRecommended']){$starTd.find('img').attr('src','images/icons/star_active.png');$starTd.children('a').attr('title','已经登上首页');}else{$starTd.find('img').attr('src','images/icons/star_unactive.png');$starTd.children('a').on('click',function(){applayToIndex($(this).parents('tr.item-card').data('act_uuid'));});$starTd.children('a').attr('title','申请登上首页');}
$itemCard.append($starTd);}
$itemCard.append('<td><img src="'+activity["logoSrc"]+'" alt="活动logo"></td>');var $nameTd=$('<td style="position:relative">'+activity["activityName"]+'</td>');if(buttomType!='management-unpublished'){$nameTd.append('<div class="td-icon" ><img src="images/icons/actNum.png" title="报名人数" style="width: 20px;height: 20px"><span >: '+activity['num']+'</span></div>');$itemCard.append($nameTd);}else{$itemCard.append($nameTd);}
$itemCard.append('<td>'+activity["location"]+'</td>');var $timeTd=$('<td></td>');$timeTd.append(activity["startTime"]+"</br>"+activity["endTime"]);$itemCard.append($timeTd);if(buttomType=='management-to_be_audited'){$itemCard.append('<td>'+activity["action"]+'</td>');}
var $buttonTd=$("<td class='buttonTd'></td>");$itemCard.data('act_uuid',activity['id']);console.log($buttonTd);var $a=$('<a class="btn btn-primary">查看</a>');$a.attr("href","show_meeting_info.html?id="+activity["id"]);$buttonTd.append($a);if(buttomType=='management-unpublished'||buttomType=='management-published'){var $aEdit=$('<a class="btn btn-my-edit">编辑</a>');$aEdit.attr("href","console_newMeeting.html?id="+activity["id"]);$buttonTd.append($aEdit);$aDel=$('<a class="btn btn-danger">删除</a>');$aDel.attr("id","delete-button-"+activity["id"]);$buttonTd.append($aDel);$aDel.on("click",function(){deleteActivity($(this).parent().parent().data('act_uuid'));});}else if(buttomType=='management-processing'||buttomType=="management-finished"){var $a=$('<a class="btn btn-my-edit">编辑</a>');$a.attr("href","console_newMeeting.html?id="+activity["id"]);$(".buttonTd").append($a);}else if(buttomType=='management-to_be_audited'){$aDel=$('<a class="btn btn-danger">删除</a>');$aDel.attr("id","delete-button-"+activity["id"]);$buttonTd.append($aDel);$aDel.on("click",function(){cancelApplication($(this).parent().parent().data('act_uuid'));});}
else if(buttomType=="my-not_start"){$acheck=$('<a class="btn btn-primary">查看门票</a>');$buttonTd.append($acheck);$acheck.on('click',function(){showQRCode($(this).parent().parent().data('act_uuid'));});$aDel=$('<a class="btn btn-danger">取消报名</a>');$aDel.attr("id","delete-button-"+activity["id"]);$buttonTd.append($aDel);$aDel.on("click",function(){canselAplay($(this).parent().parent().data('act_uuid'));});}else if(buttomType=='my-processing'){$acheck=$('<a class="btn btn-primary">查看门票</a>');$acheck.on('click',function(){showQRCode($(this).parent().parent().data('act_uuid'));});$buttonTd.append($acheck);}else if(buttomType=="fav-not_start"||buttomType=="fav-processing"||buttomType=="fav-finished"){$aDel=$('<a class="btn btn-danger">删除</a>');$aDel.attr("id","delete-button-"+activity["id"]);$buttonTd.append($aDel);$aDel.on("click",function(){cancelCollection($(this).parent().parent().data('act_uuid'));});}
$itemCard.append($buttonTd);$itemCard.hover(function(){$(this).addClass('item-row-shadow');},function(){$(this).removeClass('item-row-shadow');})
$actTableBody.append($itemCard);}
$activityTable.append($actTableBody);return $activityTable;}
function getActivityList(api,btnID,pageID,perPage,$fatherObject,isGeneratePage=false){$.ajax({url:api,data:{"btn-type":btnID,"page-id":pageID,'per-page':perPage},type:"GET",dataType:'json',success:function(data){if(isGeneratePage){$fatherObject.find('*').remove();$fatherObject.append(generateActivityTable(data,btnID));$fatherObject.append(generatePageItems(function(currentPage){getActivityList(api,btnID,currentPage,perPage,$fatherObject);},data['pageNum']));}else{$fatherObject.children('table').remove();$fatherObject.prepend(generateActivityTable(data,btnID));}
toastMessage("刷新成功！");},error:function(){toastMessage("获取信息失败！");}})}
function generatePageItems(callBackfun=null,pageNum=5,myID='console',){$nav=$('<nav></nav>');$pageUl=$('<ul class="pagination pagination-sm justify-content-center" id="page-bar"></ul>');$nav.append($pageUl);$pageUl.find('*').remove();$pageUl.data('currentPage',1);$pageUl.data('pageNum',pageNum);var $liP=$('<li class="page-item disabled">\n'+'                            <a class="page-link" href="#" id="'+myID+'-page-previous">Previous</a>\n'+'                        </li>');$pageUl.append($liP);for(var i=1;i<=pageNum;i++){var $li=$('<li class="page-item">\n'+'                            <a class="page-link" href="#"></a>\n'+'                        </li>');$li.children('a').attr('id',myID+'-page-'+i);$li.children('a').text(i);$pageUl.append($li);}
var $liN=$('<li class="page-item">\n'+'                            <a class="page-link" href="#" id="'+myID+'-page-next">next</a>\n'+'                        </li>');if(pageNum==1){$liN.addClass('disabled');}
$pageUl.append($liN);$liN.addClass('disabled');$pageUl.find('li').eq(1).addClass('active');$pageUl.find('a').each(function(index,element){$(this).on('click',function(){var pageNum=$pageUl.data('pageNum');var currentPage=$pageUl.data('currentPage');$pageUl.find('li').eq(currentPage).removeClass('active');if($(this).attr('id')=="page-previous"){currentPage-=1;}
else if($(this).attr('id')==myID+"-page-next"){currentPage+=1;}else{currentPage=$(this).attr('id').split('-').pop();}
$pageUl.find('li').eq(currentPage).addClass('active');if(pageNum<=1){$liP.addClass('disabled');$liN.addClass('disabled');}
else if(currentPage==1){$liP.addClass('disabled');$liN.removeClass('disabled');}else if(currentPage==pageNum){$liP.removeClass('disabled');$liN.addClass('disabled');}else{$liP.removeClass('disabled');$liN.removeClass('disabled');}
callBackfun(currentPage,pageNum);})});return $nav;}
function setNumInfo(id,num,maxNum=99){$('#'+id).children('span.num-info').remove();if(num<=maxNum){$('#'+id).append('<span class="num-info">'+num+'</span>');}else{$('#'+id).append('<span class="num-info">99+</span>');}}
function showQRCode(act_uuid){$.ajax({url:'api/yw/getQRcode/',type:'GET',data:{uuid_act:act_uuid},dataType:'json',success:function(data){toastMessage(data['message']);$('#QRImg').attr('src',data['qrcode']);$('.QR-window *button').on('click',function(){$(this).parent().hide();})
$('.QR-window').show();}})}
$(function(){var breadDict={management:'活动管理',my:'我的活动',fav:'我的收藏',unpublished:'未发布',published:'未开始',processing:'进行中',not_start:'未开始',to_be_audited:'待审核',finished:'已结束'}
$(function(){$("#new-activity-bottom").on('click',function(e){window.location.href="console_newMeeting.html"})});$(function(){$(".activity-list-buttom").on('click',function(e){window.location.href="index.html"})})
$("div.function-list *a[data-toggle='collapse']").on('click',function(){$('.breadcrumb *li').remove();$(this).parent().find('a').removeClass('active');items=breadDict[$(this).attr('id')];$('.breadcrumb').append(' <li class="breadcrumb-item"><a herf="#">控制台</a></li>');$('.breadcrumb').append(' <li class="breadcrumb-item active"><a herf="#">'+items+'</a></li>');$(this).addClass('active');})
$("div.function-list *div.collapse *a").on('click',function(){$(this).parent('div').find('*').removeClass('active');$(this).addClass('active');item=breadDict[$(this).attr('id').split('-')[1]];if($('.breadcrumb').find('li').length>=3){$('.breadcrumb').find('li:last-child').remove();}
$('.breadcrumb').find('li').removeClass('active');$('.breadcrumb').append(' <li class="breadcrumb-item active"><a herf="#">'+item+'</a></li>');getActivityList("api/activity/pageDisplay/",$(this).attr('id'),1,5,$('#activity-content-div'),true);});});